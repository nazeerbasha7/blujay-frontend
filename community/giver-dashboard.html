<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Helper Dashboard | Blujay Tech Community</title>
    
    <script src="../js/api-config.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="community-styles.css">
    
    <style>
        * { font-family: 'Inter', sans-serif; }
        :root {
            --blujay-primary: #0057A0;
            --blujay-hover: #00447C;
            --blujay-light: #E6F1FB;
            --blujay-dark: #00345E;
            --blujay-gradient: linear-gradient(135deg, #0057A0 0%, #0084D6 100%);
        }
        body { 
            background: linear-gradient(135deg, #f8fafc 0%, var(--blujay-light) 100%); 
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }
        
        .stat-card { 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: white;
            border-radius: 16px;
            border-left: 4px solid var(--blujay-primary);
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
        }
        .stat-card:hover { 
            transform: translateY(-6px); 
            box-shadow: 0 12px 32px rgba(0, 87, 160, 0.15);
        }
        
        .request-card { 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 16px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
        }
        .request-card:hover { 
            transform: translateY(-4px); 
            box-shadow: 0 12px 28px rgba(0, 87, 160, 0.12);
        }
        
        .profile-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: white;
            border-radius: 16px;
            border: 2px solid transparent;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
        }
        .profile-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 16px 40px rgba(0, 87, 160, 0.12);
            border-color: var(--blujay-primary);
        }
        
        .btn-primary {
            background: var(--blujay-gradient);
            transition: all 0.3s ease;
            box-shadow: 0 4px 16px rgba(0, 87, 160, 0.25);
            font-weight: 600;
        }
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 87, 160, 0.35);
            background: linear-gradient(135deg, #00447C 0%, #0057A0 100%);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal.show { display: flex; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        
        @keyframes slideIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        .modal-content { animation: slideIn 0.3s ease-out; }
        
        .tab-button { 
            transition: all 0.3s ease;
            border-radius: 12px;
            font-weight: 600;
            padding: 12px 24px;
        }
        .tab-button.active {
            background: var(--blujay-gradient);
            color: white;
            box-shadow: 0 4px 16px rgba(0, 87, 160, 0.3);
        }
        .tab-button:not(.active) {
            background: white;
            color: var(--blujay-primary);
            border: 2px solid var(--blujay-light);
        }
        .tab-button:not(.active):hover {
            background: var(--blujay-light);
        }
        
        @media (max-width: 768px) {
            .stat-card { margin-bottom: 1rem; }
            .request-card, .profile-card { padding: 1rem !important; }
            .tab-button { padding: 10px 16px; font-size: 14px; }
        }
    </style>
</head>
<body>
    
    <!-- Navbar -->
    <nav class="bg-gradient-to-r from-blue-600 to-blue-500 shadow-lg sticky top-0 z-40" style="background: var(--blujay-gradient);">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex items-center justify-between flex-wrap gap-4">
                <div class="flex items-center gap-3">
                    <img src="../images/logo.webp" alt="Blujay Tech" class="h-10 sm:h-12">
                    <div class="text-white">
                        <h2 class="font-bold text-lg sm:text-xl">Community Portal</h2>
                        <p class="text-xs sm:text-sm opacity-90">Professional Helper Dashboard</p>
                    </div>
                </div>
                <div class="flex items-center gap-3 sm:gap-4">
                    <a href="giver-profile.html" class="text-white hover:text-blue-100 transition flex items-center gap-2 text-sm sm:text-base">
                        <i class="fas fa-edit"></i> <span class="hidden sm:inline">Edit Profile</span>
                    </a>
                    <button onclick="handleLogout()" class="bg-white/20 hover:bg-white/30 text-white px-3 sm:px-4 py-2 rounded-lg transition flex items-center gap-2 text-sm sm:text-base">
                        <i class="fas fa-sign-out-alt"></i> <span class="hidden sm:inline">Logout</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>
    
    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 py-8">
        
        <!-- Welcome Section -->
        <div class="bg-gradient-to-r from-purple-600 to-blue-600 rounded-2xl shadow-xl p-6 md:p-8 mb-8 text-white fade-in">
            <div class="flex items-center justify-between flex-wrap gap-4">
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold mb-2">
                        Welcome back, <span id="userName">User</span>! üëã
                    </h1>
                    <p class="opacity-90">Review connection requests from job seekers</p>
                </div>
                <button onclick="loadConnections()" class="bg-white text-purple-600 px-6 py-3 rounded-lg font-semibold hover:bg-gray-100 transition">
                    <i class="fas fa-sync-alt mr-2"></i>Refresh
                </button>
            </div>
        </div>
        
        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="stat-card bg-white rounded-xl shadow-md p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm font-medium mb-1">Pending Requests</p>
                        <p id="pendingCount" class="text-3xl font-bold text-orange-600">0</p>
                    </div>
                    <div class="w-14 h-14 bg-orange-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-clock text-2xl text-orange-600"></i>
                    </div>
                </div>
            </div>
            
            <div class="stat-card bg-white rounded-xl shadow-md p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm font-medium mb-1">Awaiting Admin</p>
                        <p id="awaitingCount" class="text-3xl font-bold text-blue-600">0</p>
                    </div>
                    <div class="w-14 h-14 bg-blue-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-hourglass-half text-2xl text-blue-600"></i>
                    </div>
                </div>
            </div>
            
            <div class="stat-card bg-white rounded-xl shadow-md p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm font-medium mb-1">Approved Connections</p>
                        <p id="approvedCount" class="text-3xl font-bold text-green-600">0</p>
                    </div>
                    <div class="w-14 h-14 bg-green-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-check-circle text-2xl text-green-600"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tabs -->
        <div class="bg-white rounded-xl shadow-md mb-6">
            <div class="flex border-b border-gray-200">
                <button onclick="switchTab('browse')" id="browseTab" 
                    class="tab-button flex-1 px-6 py-4 font-semibold text-gray-700 hover:bg-gray-50 active">
                    <i class="fas fa-users mr-2"></i>Browse Job Seekers
                </button>
                <button onclick="switchTab('pending')" id="pendingTab" 
                    class="tab-button flex-1 px-6 py-4 font-semibold text-gray-700 hover:bg-gray-50">
                    <i class="fas fa-bell mr-2"></i>Pending Requests
                </button>
                <button onclick="switchTab('approved')" id="approvedTab"
                    class="tab-button flex-1 px-6 py-4 font-semibold text-gray-700 hover:bg-gray-50">
                    <i class="fas fa-check-circle mr-2"></i>Approved Connections
                </button>
            </div>
        </div>
        
        <!-- Browse Job Seekers Tab -->
        <div id="browseContent" class="bg-white rounded-xl shadow-md p-6 fade-in">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                    <i class="fas fa-users text-blue-600"></i>
                    Available Job Seekers
                </h3>
                <span class="text-sm text-gray-500">Verified professionals looking for opportunities</span>
            </div>
            
            <div id="loadingReceivers" class="text-center py-12">
                <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-blue-600 mx-auto mb-4"></div>
                <p class="text-gray-500">Loading job seekers...</p>
            </div>
            
            <div id="receiversGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" style="display: none;">
                <!-- Receivers will load here -->
            </div>
            
            <div id="noReceiversMessage" class="text-center py-12" style="display: none;">
                <i class="fas fa-users-slash text-6xl text-gray-300 mb-4"></i>
                <p class="text-gray-500 text-lg">No job seekers available at the moment</p>
                <p class="text-gray-400 text-sm mt-2">Check back later or refresh the page</p>
            </div>
        </div>
        
        <!-- Pending Requests Tab -->
        <div id="pendingContent" class="bg-white rounded-xl shadow-md p-6 fade-in">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                    <i class="fas fa-bell text-orange-600"></i>
                    Pending Connection Requests
                </h3>
            </div>
            
            <div id="loadingSpinner" class="text-center py-12">
                <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-purple-600 mx-auto mb-4"></div>
                <p class="text-gray-500">Loading requests...</p>
            </div>
            
            <div id="pendingList" class="space-y-4" style="display: none;">
                <!-- Pending requests will load here -->
            </div>
            
            <div id="noPendingMessage" class="text-center py-12" style="display: none;">
                <i class="fas fa-inbox text-6xl text-gray-300 mb-4"></i>
                <p class="text-gray-500 text-lg">No pending requests</p>
                <p class="text-gray-400 text-sm mt-2">You're all caught up!</p>
            </div>
        </div>
        
        <!-- Approved Connections Tab -->
        <div id="approvedContent" class="bg-white rounded-xl shadow-md p-6" style="display: none;">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                    <i class="fas fa-check-circle text-green-600"></i>
                    Approved Connections
                </h3>
            </div>
            
            <div id="approvedList" class="space-y-4">
                <!-- Approved connections will load here -->
            </div>
            
            <div id="noApprovedMessage" class="text-center py-12" style="display: none;">
                <i class="fas fa-user-friends text-6xl text-gray-300 mb-4"></i>
                <p class="text-gray-500 text-lg">No approved connections yet</p>
                <p class="text-gray-400 text-sm mt-2">Accept requests to start connecting</p>
            </div>
        </div>
        
    </div>
    
    <!-- Contact Details Modal -->
    <div id="contactModal" class="modal">
        <div class="modal-content bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 overflow-hidden">
            <!-- Modal Header -->
            <div class="bg-gradient-to-r from-purple-600 to-blue-600 p-6 text-white">
                <div class="flex items-center justify-between">
                    <h3 class="text-2xl font-bold flex items-center gap-2">
                        <i class="fas fa-address-card"></i>
                        Contact Details
                    </h3>
                    <button onclick="closeContactModal()" class="text-white hover:text-gray-200 transition">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                <p class="text-sm opacity-90 mt-1">Connection approved by admin</p>
            </div>
            
            <!-- Modal Body -->
            <div id="contactDetails" class="p-6 space-y-4">
                <!-- Details will be populated here -->
            </div>
        </div>
    </div>
    
    <!-- Firebase & Scripts -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        
        // Use the correct Blujay Tech Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyCiedANEie5u-2XQOjdsUFgdkE7s08gArY",
            authDomain: "blujay-tech.firebaseapp.com",
            projectId: "blujay-tech",
            storageBucket: "blujay-tech.firebasestorage.app",
            messagingSenderId: "586422050005",
            appId: "1:586422050005:web:737ba2502d1b283ea6165c",
            measurementId: "G-1JE665W8D0"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        
        let currentUser = null;
        let allConnections = [];
        let authUnsubscribe = null;
        let authCheckComplete = false;
        
        console.log('üèòÔ∏è Giver Dashboard - Starting...');
        
        // Set persistence FIRST before any auth checks
        setPersistence(auth, browserLocalPersistence).then(() => {
            console.log('‚úÖ Auth persistence set to LOCAL');
            
            // Now check auth - ONLY RUN ONCE using unsubscribe
            authUnsubscribe = onAuthStateChanged(auth, async (user) => {
                if (authCheckComplete) {
                    console.log('‚è∏Ô∏è Auth check already complete, skipping');
                    return;
                }
                
                console.log('üîî Auth state changed');
                
                if (!user) {
                    console.log('‚ùå No user authenticated');
                    // Give a small delay to ensure Firebase has fully loaded
                    setTimeout(() => {
                        if (!currentUser) {
                            console.log('‚ùå Redirecting to login after timeout');
                            window.location.href = '../login.html?redirect=community';
                        }
                    }, 1000);
                    return;
                }
                
                console.log('‚úÖ User authenticated:', user.email);
                currentUser = user;
                authCheckComplete = true;
                
                // Unsubscribe to prevent re-runs
                if (authUnsubscribe) {
                    console.log('üîï Unsubscribing from auth listener');
                    authUnsubscribe();
                    authUnsubscribe = null;
                }
                
                // Now run profile check
                await checkProfile();
            });
        }).catch((error) => {
            console.error('‚ùå Error setting persistence:', error);
        });
        
        async function checkProfile() {
            try {
                console.log('üîÑ Checking community profile...');
                const token = await currentUser.getIdToken();
                const API_URL = window.API_CONFIG?.getApiUrl() || 'http://localhost:5000/api';
                const response = await fetch(`${API_URL}/community/my-profile`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                console.log('üìä Profile check response:', response.status);
                
                if (!response.ok && response.status === 404) {
                    console.log('‚ùå No profile exists - Redirecting to role selection');
                    alert('Please complete your profile to access the dashboard.');
                    window.location.href = 'role-selection.html?role=giver';
                    return;
                }
                
                if (!response.ok) {
                    console.error('‚ùå Profile check failed:', response.status);
                    alert('Error loading profile. Please try again.');
                    window.location.href = 'index.html';
                    return;
                }
                
                const data = await response.json();
                console.log('‚úÖ Profile loaded:', data.profile);
                
                if (!data.profile) {
                    console.log('‚ùå No profile data - Redirecting to role selection');
                    alert('Please complete your profile to access the dashboard.');
                    window.location.href = 'role-selection.html?role=giver';
                    return;
                }
                
                // Check if wrong role - use profileType OR role field
                const userRole = data.profile.profileType || data.profile.role;
                console.log('üë§ User role from profile:', userRole);
                
                if (userRole && userRole !== 'GIVER') {
                    console.log('‚ö†Ô∏è Wrong role detected - user is', userRole, '- redirecting to receiver dashboard');
                    window.location.href = 'receiver-dashboard.html';
                    return;
                }
                
                // CRITICAL: Check verification status - MUST be VERIFIED to access dashboard
                const verificationStatus = data.profile.verificationStatus;
                console.log('üîç Verification Status:', verificationStatus);
                
                if (!verificationStatus || verificationStatus !== 'VERIFIED') {
                    console.log('‚è≥ Profile NOT verified (Status:', verificationStatus, ') - Redirecting to verification pending');
                    window.location.href = 'verification-pending.html?role=giver';
                    return;
                }
                
                console.log('‚úÖ Profile VERIFIED - Allowing dashboard access');
                
                // Check if profile is active
                if (data.profile.isActive === false) {
                    console.log('‚ùå Profile is inactive');
                    alert('Your profile has been deactivated. Please contact admin.');
                    window.location.href = 'index.html';
                    return;
                }
                
                console.log('‚úÖ All checks passed - loading dashboard');
                document.getElementById('userName').textContent = data.profile.fullName?.split(' ')[0] || currentUser.displayName?.split(' ')[0] || 'User';
                
                await loadAvailableReceivers();
                await loadConnections();
                setInterval(loadConnections, 30000); // Auto-refresh every 30 seconds
            } catch (error) {
                console.error('‚ùå Error in checkProfile:', error);
                // Don't alert or redirect - just show dashboard with basic info
                document.getElementById('userName').textContent = currentUser?.displayName?.split(' ')[0] || 'User';
                // Try to load connections anyway
                try {
                    await loadConnections();
                } catch (e) {
                    console.error('‚ùå Error loading connections:', e);
                    document.getElementById('loadingSpinner').style.display = 'none';
                    document.getElementById('noPendingMessage').style.display = 'block';
                    document.getElementById('pendingList').style.display = 'none';
                }
            }
        }
        
        let allReceivers = [];
        
        window.loadAvailableReceivers = async function() {
            try {
                console.log('üîÑ Loading available job seekers...');
                
                if (!currentUser) {
                    console.error('‚ùå No current user');
                    document.getElementById('loadingReceivers').style.display = 'none';
                    return;
                }
                
                const token = await currentUser.getIdToken();
                const API_URL = window.API_CONFIG?.getApiUrl() || 'http://localhost:5000/api';
                const response = await fetch(`${API_URL}/community/profiles?type=RECEIVER&status=VERIFIED`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('‚úÖ Job seekers loaded:', data.profiles?.length || 0);
                allReceivers = data.profiles || [];
                
                document.getElementById('loadingReceivers').style.display = 'none';
                
                if (allReceivers.length === 0) {
                    document.getElementById('noReceiversMessage').style.display = 'block';
                    document.getElementById('receiversGrid').style.display = 'none';
                } else {
                    document.getElementById('noReceiversMessage').style.display = 'none';
                    document.getElementById('receiversGrid').style.display = 'grid';
                    renderReceivers();
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('loadingReceivers').style.display = 'none';
                document.getElementById('noReceiversMessage').style.display = 'block';
            }
        };
        
        function renderReceivers() {
            const grid = document.getElementById('receiversGrid');
            grid.innerHTML = allReceivers.map(receiver => {
                const alreadyConnected = allConnections.some(conn => 
                    conn.receiverId === receiver.userId || conn.senderId === receiver.userId
                );
                
                return `
                    <div class="profile-card bg-white border-2 border-gray-200 rounded-xl p-6 hover:border-purple-400">
                        <div class="flex items-start gap-4 mb-4">
                            <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-purple-500 rounded-full flex items-center justify-center text-white text-2xl font-bold flex-shrink-0">
                                ${receiver.fullName.charAt(0)}
                            </div>
                            <div class="flex-1 min-w-0">
                                <h4 class="font-bold text-gray-800 text-lg truncate">${receiver.fullName}</h4>
                                <p class="text-sm text-gray-600 truncate">${receiver.currentRole || 'Job Seeker'}</p>
                            </div>
                        </div>
                        
                        <div class="mb-4 space-y-2 text-sm text-gray-600">
                            <p><i class="fas fa-map-marker-alt text-purple-600 w-4"></i> ${receiver.location || 'Not specified'}</p>
                            ${receiver.experienceYears ? `<p><i class="fas fa-briefcase text-purple-600 w-4"></i> ${receiver.experienceYears} years experience</p>` : ''}
                        </div>
                        
                        ${receiver.skills && receiver.skills.length > 0 ? `
                        <div class="mb-4">
                            <p class="text-xs text-gray-500 mb-2">Skills:</p>
                            <div class="flex flex-wrap gap-1">
                                ${receiver.skills.slice(0, 3).map(skill => `
                                    <span class="px-2 py-1 bg-purple-100 text-purple-800 text-xs rounded-full">${skill}</span>
                                `).join('')}
                                ${receiver.skills.length > 3 ? `<span class="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded-full">+${receiver.skills.length - 3}</span>` : ''}
                            </div>
                        </div>
                        ` : ''}
                        
                        ${receiver.bio ? `<p class="text-sm text-gray-600 mb-4 line-clamp-2">${receiver.bio}</p>` : ''}
                        
                        <button onclick="sendConnectionRequest('${receiver.userId._id || receiver.userId}', this)" 
                            ${alreadyConnected ? 'disabled' : ''}
                            class="btn-primary w-full text-white font-semibold py-3 rounded-lg ${alreadyConnected ? 'opacity-50 cursor-not-allowed' : ''}">
                            ${alreadyConnected ? '<i class="fas fa-check mr-2"></i>Already Connected' : '<i class="fas fa-paper-plane mr-2"></i>Send Request'}
                        </button>
                    </div>
                `;
            }).join('');
        }
        
        window.loadConnections = async function() {
            try {
                console.log('üîÑ Loading connections...');
                
                if (!currentUser) {
                    console.error('‚ùå No current user');
                    document.getElementById('loadingSpinner').style.display = 'none';
                    return;
                }
                
                const token = await currentUser.getIdToken();
                const API_URL = window.API_CONFIG?.getApiUrl() || 'http://localhost:5000/api';
                console.log('üì° Fetching from:', `${API_URL}/community/connections`);
                
                const response = await fetch(`${API_URL}/community/connections`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå API Error:', response.status, errorText);
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('‚úÖ API Response:', data);
                console.log('‚úÖ Connections loaded:', data.connections?.length || 0);
                
                if (data.connections && data.connections.length > 0) {
                    console.log('üìã First connection structure:', data.connections[0]);
                }
                
                allConnections = data.connections || [];
                
                // Update stats
                const pending = allConnections.filter(c => c.status === 'REQUESTED').length;
                const awaiting = allConnections.filter(c => c.status === 'USER_ACCEPTED').length;
                const approved = allConnections.filter(c => c.status === 'ADMIN_APPROVED').length;
                
                console.log('üìä Stats - Pending:', pending, 'Awaiting:', awaiting, 'Approved:', approved);
                
                document.getElementById('pendingCount').textContent = pending;
                document.getElementById('awaitingCount').textContent = awaiting;
                document.getElementById('approvedCount').textContent = approved;
                
                // Render current tab
                if (document.getElementById('pendingContent').style.display !== 'none') {
                    renderPendingRequests();
                } else {
                    renderApprovedConnections();
                }
                
                document.getElementById('loadingSpinner').style.display = 'none';
            } catch (error) {
                console.error('‚ùå Error loading connections:', error);
                document.getElementById('loadingSpinner').style.display = 'none';
                // Show empty state
                document.getElementById('noPendingMessage').style.display = 'block';
                document.getElementById('pendingList').style.display = 'none';
                // Don't throw error - just log it
            }
        };
        
        function renderPendingRequests() {
            try {
                console.log('üé® Rendering pending requests...', allConnections.length, 'total connections');
                const pending = allConnections.filter(c => c.status === 'REQUESTED' || c.status === 'USER_ACCEPTED');
                console.log('üìã Pending connections:', pending.length);
                const list = document.getElementById('pendingList');
                
                if (pending.length === 0) {
                    console.log('‚ÑπÔ∏è No pending requests to show');
                    document.getElementById('noPendingMessage').style.display = 'block';
                    document.getElementById('pendingList').style.display = 'none';
                    return;
                }
                
                document.getElementById('noPendingMessage').style.display = 'none';
                document.getElementById('pendingList').style.display = 'block';
                
                list.innerHTML = pending.map((conn, index) => {
                    console.log(`Processing connection ${index + 1}:`, conn);
                    // Backend returns otherUser and otherProfile for professional helpers
                    const senderProfile = conn.otherProfile || {};
                    const sender = conn.otherUser || {};
                    const isAwaitingAdmin = conn.status === 'USER_ACCEPTED';
                    
                    // Safeguard: Skip if no valid user info
                    if (!sender.name && !sender.email && !senderProfile.fullName) {
                        console.warn('‚ö†Ô∏è Skipping connection with no user info:', conn._id);
                        return '';
                    }
                
                return `
                    <div class="request-card bg-gradient-to-r from-${isAwaitingAdmin ? 'blue' : 'orange'}-50 to-white border-2 border-${isAwaitingAdmin ? 'blue' : 'orange'}-200 rounded-xl p-6">
                        <div class="flex items-start gap-4 mb-4">
                            <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-purple-500 rounded-full flex items-center justify-center text-white text-2xl font-bold flex-shrink-0">
                                ${(senderProfile.fullName || sender.name || 'U').charAt(0)}
                            </div>
                            <div class="flex-1">
                                <h4 class="text-xl font-bold text-gray-800 mb-1">${senderProfile.fullName || sender.name || 'Unknown'}</h4>
                                <p class="text-gray-600 mb-2">${senderProfile.currentRole || senderProfile.experience || 'Job Seeker'}</p>
                                <div class="flex flex-wrap gap-2 text-sm text-gray-600">
                                    <span><i class="fas fa-map-marker-alt text-blue-600 mr-1"></i>${senderProfile.location || 'Location not set'}</span>
                                    <span><i class="fas fa-envelope text-blue-600 mr-1"></i>${sender.email || 'Email not available'}</span>
                                </div>
                            </div>
                        </div>
                        
                        ${senderProfile.skills && senderProfile.skills.length > 0 ? `
                        <div class="mb-4">
                            <p class="text-sm text-gray-600 mb-2"><strong>Skills:</strong></p>
                            <div class="flex flex-wrap gap-2">
                                ${senderProfile.skills.map(skill => `
                                    <span class="px-3 py-1 bg-blue-100 text-blue-800 text-sm rounded-full">${skill}</span>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}
                        
                        ${senderProfile.about ? `
                            <div class="mb-4 p-4 bg-white rounded-lg">
                                <p class="text-sm text-gray-700">${senderProfile.about}</p>
                            </div>
                        ` : ''}
                        
                        ${isAwaitingAdmin ? `
                            <div class="bg-blue-100 border-2 border-blue-300 rounded-lg p-4 text-center">
                                <i class="fas fa-hourglass-half text-blue-600 text-2xl mb-2"></i>
                                <p class="font-semibold text-blue-800">Awaiting Admin Approval</p>
                                <p class="text-sm text-blue-600 mt-1">You accepted this request. Admin will review soon.</p>
                            </div>
                        ` : `
                            <div class="flex gap-3">
                                <button onclick="acceptRequest('${conn._id}')" 
                                    class="flex-1 bg-gradient-to-r from-green-500 to-green-600 text-white font-semibold py-3 rounded-lg hover:shadow-lg transition">
                                    <i class="fas fa-check mr-2"></i>Accept Request
                                </button>
                                <button onclick="declineRequest('${conn._id}')" 
                                    class="flex-1 bg-gradient-to-r from-red-500 to-red-600 text-white font-semibold py-3 rounded-lg hover:shadow-lg transition">
                                    <i class="fas fa-times mr-2"></i>Decline
                                </button>
                            </div>
                        `}
                    </div>
                `;
                }).filter(html => html.trim() !== '').join('');
                console.log('‚úÖ Pending requests rendered successfully');
            } catch (error) {
                console.error('‚ùå Error in renderPendingRequests:', error);
                document.getElementById('noPendingMessage').style.display = 'block';
                document.getElementById('pendingList').style.display = 'none';
            }
        }
        
        function renderApprovedConnections() {
            try {
                console.log('üé® Rendering approved connections...');
                const approved = allConnections.filter(c => c.status === 'ADMIN_APPROVED');
                console.log('‚úÖ Approved connections:', approved.length);
                const list = document.getElementById('approvedList');
                
                if (approved.length === 0) {
                    console.log('‚ÑπÔ∏è No approved connections to show');
                    document.getElementById('noApprovedMessage').style.display = 'block';
                    list.innerHTML = '';
                    return;
                }
                
                document.getElementById('noApprovedMessage').style.display = 'none';
            
            list.innerHTML = approved.map(conn => {
                    // Backend returns otherUser and otherProfile
                    const senderProfile = conn.otherProfile || {};
                    const sender = conn.otherUser || {};
                    
                    // Safeguard: Skip if no valid user info
                    if (!sender.name && !sender.email && !senderProfile.fullName) {
                        console.warn('‚ö†Ô∏è Skipping approved connection with no user info:', conn._id);
                        return '';
                    }
                
                return `
                    <div class="bg-gradient-to-r from-green-50 to-blue-50 border-2 border-green-200 rounded-xl p-6">
                        <div class="flex items-center justify-between gap-4 flex-wrap">
                            <div class="flex items-center gap-4">
                                <div class="w-14 h-14 bg-gradient-to-br from-green-500 to-blue-500 rounded-full flex items-center justify-center text-white text-xl font-bold">
                                    ${(senderProfile.fullName || sender.name || 'U').charAt(0)}
                                </div>
                                <div>
                                    <h5 class="text-lg font-bold text-gray-800">${senderProfile.fullName || sender.name || 'Unknown'}</h5>
                                    <p class="text-gray-600">${senderProfile.currentRole || senderProfile.experience || 'Job Seeker'}</p>
                                </div>
                            </div>
                            <button onclick="viewContactDetails('${conn._id}')" 
                                class="bg-gradient-to-r from-blue-500 to-purple-600 text-white px-6 py-3 rounded-lg font-semibold hover:shadow-lg transition">
                                <i class="fas fa-address-card mr-2"></i>View Contact
                            </button>
                        </div>
                    </div>
                `;
                }).filter(html => html.trim() !== '').join('');
                console.log('‚úÖ Approved connections rendered successfully');
            } catch (error) {
                console.error('‚ùå Error in renderApprovedConnections:', error);
                document.getElementById('noApprovedMessage').style.display = 'block';
                document.getElementById('approvedList').innerHTML = '';
            }
        }
        
        window.switchTab = function(tab) {
            // Update tab buttons
            document.getElementById('browseTab').classList.remove('active');
            document.getElementById('pendingTab').classList.remove('active');
            document.getElementById('approvedTab').classList.remove('active');
            
            // Show/hide content
            if (tab === 'browse') {
                document.getElementById('browseTab').classList.add('active');
                document.getElementById('browseContent').style.display = 'block';
                document.getElementById('pendingContent').style.display = 'none';
                document.getElementById('approvedContent').style.display = 'none';
                renderReceivers();
            } else if (tab === 'pending') {
                document.getElementById('pendingTab').classList.add('active');
                document.getElementById('browseContent').style.display = 'none';
                document.getElementById('pendingContent').style.display = 'block';
                document.getElementById('approvedContent').style.display = 'none';
                renderPendingRequests();
            } else {
                document.getElementById('approvedTab').classList.add('active');
                document.getElementById('browseContent').style.display = 'none';
                document.getElementById('pendingContent').style.display = 'none';
                document.getElementById('approvedContent').style.display = 'block';
                renderApprovedConnections();
            }
        };
        
        window.sendConnectionRequest = async function(receiverId, buttonElement) {
            // Get the button element if not passed directly
            if (!buttonElement) {
                buttonElement = event.target;
            }
            
            if (!confirm('Send connection request to this job seeker?')) return;
            
            // Disable button immediately and update UI
            buttonElement.disabled = true;
            buttonElement.classList.add('opacity-50', 'cursor-not-allowed', 'bg-gray-400');
            buttonElement.classList.remove('btn-primary');
            buttonElement.innerHTML = '<i class="fas fa-clock mr-2"></i>Sending...';
            
            try {
                console.log('üì§ Sending connection request to:', receiverId);
                const token = await currentUser.getIdToken();
                const API_URL = window.API_CONFIG?.getApiUrl() || 'http://localhost:5000/api';
                const url = `${API_URL}/community/connection/request`;
                console.log('üéØ Posting to:', url);
                
                const payload = { targetUserId: receiverId };
                console.log('üì¶ Payload:', payload);
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(payload)
                });
                
                console.log('üìä Response status:', response.status);
                
                const data = await response.json();
                console.log('üìä Response data:', data);
                
                if (response.ok) {
                    buttonElement.innerHTML = '<i class="fas fa-check mr-2"></i>Request Sent';
                    alert('‚úÖ Connection request sent successfully!');
                    await loadConnections();
                    await loadAvailableReceivers(); // Refresh to update button state
                } else {
                    console.error('‚ùå Request failed:', data);
                    // Re-enable button on error
                    buttonElement.disabled = false;
                    buttonElement.classList.remove('opacity-50', 'cursor-not-allowed', 'bg-gray-400');
                    buttonElement.classList.add('btn-primary');
                    buttonElement.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>Send Request';
                    alert('‚ùå ' + (data.message || 'Failed to send request'));
                }
            } catch (error) {
                console.error('‚ùå Error sending request:', error);
                // Re-enable button on error
                buttonElement.disabled = false;
                buttonElement.classList.remove('opacity-50', 'cursor-not-allowed', 'bg-gray-400');
                buttonElement.classList.add('btn-primary');
                buttonElement.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>Send Request';
                alert('‚ùå Error: ' + error.message);
            }
        };
        
        window.acceptRequest = async function(connectionId) {
            if (!confirm('Accept this connection request? After acceptance, both of you will wait for admin approval to reveal contact details.')) return;
            
            try {
                console.log('‚úÖ Accepting connection:', connectionId);
                const token = await currentUser.getIdToken();
                const API_URL = window.API_CONFIG?.getApiUrl() || 'http://localhost:5000/api';
                const response = await fetch(`${API_URL}/community/connection/${connectionId}/respond`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        action: 'accept',
                        note: 'Accepted - Waiting for admin approval'
                    })
                });
                
                const data = await response.json();
                console.log('üìä Accept response:', data);
                
                if (response.ok) {
                    alert('‚úÖ Request accepted! Both users are now waiting for admin approval to reveal contact details.');
                    await loadConnections();
                } else {
                    alert('‚ùå ' + (data.message || 'Failed to accept request'));
                }
            } catch (error) {
                console.error('‚ùå Error accepting request:', error);
                alert('‚ùå Error accepting request');
            }
        };
        
        window.declineRequest = async function(connectionId) {
            if (!confirm('Are you sure you want to decline this request?')) return;
            
            try {
                console.log('‚ùå Declining connection:', connectionId);
                const token = await currentUser.getIdToken();
                const API_URL = window.API_CONFIG?.getApiUrl() || 'http://localhost:5000/api';
                const response = await fetch(`${API_URL}/community/connection/${connectionId}/respond`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        action: 'reject',
                        note: 'Declined by user'
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('‚úÖ Request declined');
                    await loadConnections();
                } else {
                    alert('‚ùå ' + (data.message || 'Failed to decline request'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Error declining request');
            }
        };
        
        window.viewContactDetails = function(connectionId) {
            const conn = allConnections.find(c => c._id === connectionId);
            if (!conn) return;
            
            // Backend returns otherUser and otherProfile
            const senderProfile = conn.otherProfile || {};
            const sender = conn.otherUser || {};
            
            const detailsHtml = `
                <div class="space-y-4">
                    <div class="text-center mb-4">
                        <div class="w-20 h-20 mx-auto bg-gradient-to-br from-green-500 to-blue-500 rounded-full flex items-center justify-center text-white text-3xl font-bold mb-3">
                            ${(senderProfile.fullName || sender.name || 'U').charAt(0)}
                        </div>
                        <h4 class="text-xl font-bold text-gray-800">${senderProfile.fullName || sender.name || 'Unknown'}</h4>
                        <p class="text-gray-600">${senderProfile.currentRole || senderProfile.experience || 'Job Seeker'}</p>
                    </div>
                    
                    ${senderProfile.mobileNumber || conn.mobileNumbersRevealed ? `
                    <div class="bg-green-50 border-2 border-green-200 rounded-xl p-4">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-phone text-green-600"></i>
                                <span class="font-semibold text-gray-700">Mobile Number</span>
                            </div>
                            <button onclick="copyToClipboard('${senderProfile.mobileNumber}')" class="text-blue-600 hover:text-blue-700 text-sm">
                                <i class="fas fa-copy mr-1"></i>Copy
                            </button>
                        </div>
                        <a href="tel:${senderProfile.mobileNumber}" class="text-lg font-bold text-green-700 hover:text-green-800">
                            ${senderProfile.mobileNumber}
                        </a>
                    </div>
                    ` : ''}
                    
                    ${senderProfile.email || sender.email ? `
                    <div class="bg-blue-50 border-2 border-blue-200 rounded-xl p-4">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-envelope text-blue-600"></i>
                                <span class="font-semibold text-gray-700">Email Address</span>
                            </div>
                            <button onclick="copyToClipboard('${senderProfile.email || sender.email}')" class="text-blue-600 hover:text-blue-700 text-sm">
                                <i class="fas fa-copy mr-1"></i>Copy
                            </button>
                        </div>
                        <a href="mailto:${senderProfile.email || sender.email}" class="text-lg font-bold text-blue-700 hover:text-blue-800 break-all">
                            ${senderProfile.email || sender.email}
                        </a>
                    </div>
                    ` : ''}
                    
                    ${senderProfile.linkedIn ? `
                        <div class="bg-purple-50 border-2 border-purple-200 rounded-xl p-4">
                            <div class="flex items-center gap-2 mb-2">
                                <i class="fab fa-linkedin text-purple-600"></i>
                                <span class="font-semibold text-gray-700">LinkedIn Profile</span>
                            </div>
                            <a href="${senderProfile.linkedIn}" target="_blank" class="text-purple-700 hover:text-purple-800 text-sm break-all">
                                ${senderProfile.linkedIn}
                            </a>
                        </div>
                    ` : ''}
                    
                    ${senderProfile.skills && senderProfile.skills.length > 0 ? `
                        <div class="bg-gray-50 border-2 border-gray-200 rounded-xl p-4">
                            <p class="font-semibold text-gray-700 mb-2">Skills:</p>
                            <div class="flex flex-wrap gap-2">
                                ${senderProfile.skills.map(skill => `
                                    <span class="px-3 py-1 bg-blue-100 text-blue-800 text-sm rounded-full">${skill}</span>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
            
            document.getElementById('contactDetails').innerHTML = detailsHtml;
            document.getElementById('contactModal').classList.add('show');
        };
        
        window.closeContactModal = function() {
            document.getElementById('contactModal').classList.remove('show');
        };
        
        window.copyToClipboard = function(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('‚úÖ Copied to clipboard!');
            });
        };
        
        // Close modal on outside click
        document.getElementById('contactModal').addEventListener('click', (e) => {
            if (e.target.id === 'contactModal') {
                window.closeContactModal();
            }
        });
        
        window.handleLogout = async function() {
            if (confirm('Are you sure you want to logout?')) {
                try {
                    await signOut(auth);
                    console.log('‚úÖ Logged out successfully, redirecting to community index...');
                    window.location.href = 'index.html';
                } catch (error) {
                    console.error('‚ùå Logout error:', error);
                    alert('Error logging out. Please try again.');
                }
            }
        };
    </script>
    
</body>
</html>
